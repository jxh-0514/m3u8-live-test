<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV 播放器</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer@1.27.1/dist/DPlayer.min.js"></script>
</head>

<body class="dark-mode">
    <div class="container">
        <div class="sidebar">
            <div class="channel-header">
                <h2>频道列表</h2>
                <button id="toggleTheme" class="theme-toggle">切换主题</button>
            </div>
            <div class="channel-input">
                <input type="text" id="channelUrl" class="url-input" placeholder="输入频道列表地址 (m3u8)"
                    value="https://raw.githubusercontent.com/ngo5/IPTV/main/m3u/Heilongjiangipv4chinamobilePLTV.txt">
                <button id="loadChannels" class="load-btn">加载频道</button>
            </div>
            <div class="channel-actions">
                <div class="check-buttons">
                    <button id="checkChannels" class="check-btn" disabled>检测频道</button>
                    <button id="continueCheck" class="check-btn continue" style="display: none">继续检测</button>
                    <button id="restartCheck" class="check-btn restart" style="display: none">重新检测</button>
                </div>
                <div class="check-progress">
                    <span id="checkProgress"></span>
                    <div id="checkStats" class="check-stats">
                        <div class="stat available">
                            <span>可用:</span>
                            <span id="availableCount">0</span>
                        </div>
                        <div class="stat unavailable">
                            <span>不可用:</span>
                            <span id="unavailableCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="channel-list" id="channelList">
                <!-- 频道列表将通过JavaScript动态加载 -->
            </div>
        </div>
        <div class="main-content">
            <div id="playerContainer" class="player-container">
                <div id="dplayer"></div>
            </div>
            <div class="player-header">
                <input type="text" id="streamUrl" class="url-input" placeholder="输入直播流地址 (m3u8)">
                <button id="playStream" class="play-btn">播放</button>
                <div class="proxy-toggle">
                    <label class="switch">
                        <input type="checkbox" id="proxyToggle" checked>
                        <span class="slider round"></span>
                    </label>
                    <span class="proxy-label">启用代理</span>
                </div>
            </div>
            <div id="notification" class="notification hidden">
                <!-- 通知内容将通过JavaScript动态更新 -->
            </div>
        </div>
    </div>

    <script type="module">
        import { player } from './player.js';
        import { channelChecker } from './channelChecker.js';
        import Utils from './utils.js';
        import { notification } from './notification.js';

        // 设置 Worker URL（部署后需要更新为实际的 Worker URL）
        const WORKER_URL = 'https://m3u8-proxy.1942499981.workers.dev';
        player.setProxyUrl(WORKER_URL);

        let currentChannels = [];
        let isChecking = false;
        const checkButton = document.getElementById('checkChannels');
        const continueButton = document.getElementById('continueCheck');
        const restartButton = document.getElementById('restartCheck');
        const progressSpan = document.getElementById('checkProgress');
        const availableCountSpan = document.getElementById('availableCount');
        const unavailableCountSpan = document.getElementById('unavailableCount');

        /**
         * 更新检测统计
         */
        function updateCheckStats() {
            const available = currentChannels.filter(c => c.isAvailable === true).length;
            const unavailable = currentChannels.filter(c => c.isAvailable === false).length;
            availableCountSpan.textContent = available;
            unavailableCountSpan.textContent = unavailable;
        }

        /**
         * 更新按钮状态
         * @param {string} state - 当前状态：'idle' | 'checking' | 'paused'
         */
        function updateButtonState(state) {
            switch (state) {
                case 'idle':
                    checkButton.textContent = '检测频道';
                    checkButton.classList.remove('checking');
                    checkButton.style.display = '';
                    continueButton.style.display = 'none';
                    restartButton.style.display = 'none';
                    break;
                case 'checking':
                    checkButton.textContent = '中断检测';
                    checkButton.classList.add('checking');
                    checkButton.style.display = '';
                    continueButton.style.display = 'none';
                    restartButton.style.display = 'none';
                    break;
                case 'paused':
                    checkButton.style.display = 'none';
                    continueButton.style.display = '';
                    restartButton.style.display = '';
                    break;
            }
        }

        /**
         * 重置频道状态和检测进度
         */
        function resetChannelStatus() {
            // 重置频道状态
            currentChannels = currentChannels.map(channel => ({
                name: channel.name,
                url: channel.url
            }));
            // 重置检测进度
            progressSpan.textContent = '';
            // 重置统计数据
            availableCountSpan.textContent = '0';
            unavailableCountSpan.textContent = '0';
            // 重置检测器状态
            channelChecker.lastCheckedIndex = -1;
            // 更新界面
            updateChannelList(currentChannels);
        }

        /**
         * 加载频道列表
         * @param {string} url - 频道列表地址
         */
        async function loadChannelList(url) {
            if (!url) return;

            try {
                currentChannels = await player.loadChannels(url);
                checkButton.disabled = false;
                progressSpan.textContent = '';
                updateChannelList(currentChannels);
                updateCheckStats();
                updateButtonState('idle');
            } catch (error) {
                currentChannels = [];
                checkButton.disabled = true;
                progressSpan.textContent = '';
                updateCheckStats();
            }
        }

        /**
         * 更新频道列表显示
         * @param {Array<{name: string, url: string, isAvailable?: boolean}>} channels - 频道列表
         * @param {number} [updateIndex] - 需要更新的频道索引，如果不提供则更新整个列表
         */
        function updateChannelList(channels, updateIndex) {
            const channelList = document.getElementById('channelList');

            if (updateIndex === undefined) {
                // 更新整个列表
                channelList.innerHTML = '';
                channels.forEach((channel, index) => {
                    channelList.appendChild(createChannelElement(channel, index));
                });
            } else {
                // 只更新指定索引的频道
                const oldElement = channelList.children[updateIndex];
                if (oldElement) {
                    const newElement = createChannelElement(channels[updateIndex], updateIndex);
                    channelList.replaceChild(newElement, oldElement);
                }
            }
        }

        /**
         * 创建频道元素
         * @param {Object} channel - 频道信息
         * @param {number} index - 频道索引
         * @returns {HTMLElement} 频道元素
         */
        function createChannelElement(channel, index) {
            const channelDiv = document.createElement('div');
            let className = 'channel-item';
            let status = '';

            if (channel.isAvailable === true) {
                className += ' available';
                status = '✓ 可用';
            } else if (channel.isAvailable === false) {
                className += ' unavailable';
                status = '✗ 不可用';
            }

            channelDiv.className = className;
            channelDiv.innerHTML = `
                <span class="name">${channel.name}</span>
                ${status ? `<span class="status">${status}</span>` : ''}
            `;

            if (channel.isAvailable !== false) {
                channelDiv.onclick = () => {
                    document.querySelectorAll('.channel-item').forEach((item) => {
                        item.classList.remove('active');
                    });
                    channelDiv.classList.add('active');
                    // 更新输入框中的地址
                    document.getElementById('streamUrl').value = channel.url;
                    player.play(channel.url);
                };
            }

            return channelDiv;
        }

        // 绑定加载频道列表事件
        document.getElementById('loadChannels').addEventListener('click', () => {
            const url = document.getElementById('channelUrl').value;
            loadChannelList(url);
        });

        // 绑定检测频道事件
        checkButton.addEventListener('click', () => {
            if (isChecking) {
                // 中断检测
                isChecking = false;
                channelChecker.stopChecking(); // 调用中断方法
                updateButtonState('paused');
                notification.warning('已中断频道检测');
                return;
            }
            startChannelCheck(0);
        });

        // 绑定继续检测事件
        continueButton.addEventListener('click', () => {
            const startIndex = channelChecker.getLastCheckedIndex() + 1;
            if (startIndex >= currentChannels.length) {
                notification.warning('已完成所有频道检测');
                updateButtonState('idle');
                return;
            }
            notification.info(`从第 ${startIndex + 1} 个频道继续检测...`);
            startChannelCheck(startIndex);
        });

        // 绑定重新检测事件
        restartButton.addEventListener('click', () => {
            channelChecker.stopChecking(); // 确保停止之前的检测
            resetChannelStatus();
            notification.info('重新开始检测频道...');
            startChannelCheck(0);
        });

        /**
         * 开始检测频道
         * @param {number} startIndex - 开始检测的索引
         */
        async function startChannelCheck(startIndex) {
            if (currentChannels.length === 0) {
                notification.warning('请先加载频道列表');
                return;
            }

            isChecking = true;
            updateButtonState('checking');

            // 如果是重新开始检测，显示初始进度
            if (startIndex === 0) {
                progressSpan.textContent = Utils.formatProgress(0, currentChannels.length);
            }

            try {
                await channelChecker.checkChannels(
                    currentChannels,
                    (checked, total) => {
                        if (isChecking) { // 只在检测进行时更新进度
                            progressSpan.textContent = Utils.formatProgress(checked, total);
                        }
                    },
                    (result, index) => {
                        if (isChecking) { // 只在检测进行时更新结果
                            currentChannels[index] = result;
                            updateChannelList(currentChannels, index);
                            updateCheckStats();
                        }
                    },
                    startIndex
                );

                if (isChecking) {
                    notification.success(Utils.formatResults(currentChannels));
                    updateButtonState('idle');
                }
            } catch (error) {
                if (error.message !== '检测被中断') {
                    notification.error('检测过程中发生错误');
                    console.error('检测错误:', error);
                }
                updateButtonState('paused');
            } finally {
                isChecking = false;
            }
        }

        // 绑定播放流事件
        document.getElementById('playStream').addEventListener('click', () => {
            const url = document.getElementById('streamUrl').value;
            if (url) {
                player.play(url);
            }
        });

        // 页面加载完成后自动加载频道列表
        window.addEventListener('DOMContentLoaded', () => {
            const defaultUrl = document.getElementById('channelUrl').value;
            loadChannelList(defaultUrl);
        });
    </script>
</body>

</html>